# TIL: 모델 양자화(Quantization) 방법론

## 1. 양자화(Quantization)의 개념

양자화는 딥러닝 모델의 가중치(weights)와 활성화(activations) 값을 실수형 데이터 타입에서 더 작은 크기의 정수형 데이터 타입으로 변환하여 모델의 크기와 계산 속도를 최적화하는 기술이다. 대표적으로 FP32에서 FP16 또는 INT8로 변환하여 사용한다.

## 2. 양자화의 장점

- **모델 크기 축소**
  - 메모리 점유율이 크게 감소하여 저장 공간이 절약된다.

- **추론 속도 향상**
  - 연산 과정이 간소화되어 하드웨어에서 더 빠른 연산이 가능해진다.

- **모바일 및 임베디드 기기에 적합**
  - 계산 자원이 제한된 임베디드 환경에서도 효율적인 추론을 지원한다.

## 3. TensorFlow에서의 양자화 구현 방법

TensorFlow에서는 주로 TFLite를 활용하여 양자화를 구현한다. 대표적인 방법은 다음과 같다.

### 사후 정수 양자화(Post-training Quantization)

모델 학습 완료 후, 별도의 추가 학습 없이 양자화를 수행하는 방법이다.

```python
import tensorflow as tf

# Keras 모델 로드
model = tf.keras.models.load_model('model.h5')

# TFLite Converter 설정
converter = tf.lite.TFLiteConverter.from_keras_model(model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]

# INT8 양자화 적용
quantized_tflite_model = converter.convert()

# 양자화된 모델 저장
with open('quantized_model.tflite', 'wb') as f:
    f.write(quantized_tflite_model)
```

### 양자화 인지 학습(QAT, Quantization-aware Training)

학습 과정에서 양자화의 영향을 고려하여 양자화 손실을 최소화하는 방법이다.

```python
import tensorflow as tf
import tensorflow_model_optimization as tfmot

# Keras 모델 정의
model = tf.keras.Sequential([...])

# 양자화 인지 학습 적용
quantize_model = tfmot.quantization.keras.quantize_model
qat_model = quantize_model(model)

# 모델 컴파일 및 학습
qat_model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])
qat_model.fit(train_data, epochs=10, validation_data=val_data)

# 양자화된 모델로 변환
converter = tf.lite.TFLiteConverter.from_keras_model(qat_model)
converter.optimizations = [tf.lite.Optimize.DEFAULT]
qat_tflite_model = converter.convert()

# 양자화 모델 저장
with open('qat_quantized_model.tflite', 'wb') as f:
    f.write(qat_tflite_model)
```

## 4. 적용 권장 순서

일반적으로 다음 순서를 권장한다.

1. 모델 학습 완료
2. 사후 양자화로 기본 양자화 적용 후 성능 평가
3. 성능 저하가 크다면 양자화 인지 학습(QAT)을 통해 추가 최적화

## 5. 양자화 적용 시 주의사항

- 양자화 과정에서 성능 저하 가능성이 있으므로 양자화 전후의 성능 평가가 필수적이다.
- QAT를 사용할 때는 기존 학습 파이프라인에 양자화 층이 추가되므로 학습 시간이 늘어날 수 있다.

## 결론

양자화를 통해 모델을 경량화하면 임베디드 및 모바일 환경에서 효율적인 추론이 가능하다. 사후 정수 양자화와 양자화 인지 학습 중 목적과 상황에 맞게 적절히 선택하여 활용하면 성능과 효율을 동시에 확보할 수 있다.

